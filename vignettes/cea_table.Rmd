---
title: "Calculation of Incremental Cost-Effectiveness Ratios"
author: "Fernando Alarid-Escudero, Caleb Easterly, Eva Enns, and the DARTH Team"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 7,
  fig.height = 5,
  fig.align = "center"
)
```

# ICERS

**information here**

# Example 1: *C diff*

## Data

We use a PSA from a study of *C difficile*. A `dampack` PSA object has already been created.

```{r}
library(dampack)
data("cdiff_psa")
```

To use the PSA object in `calculate_icers()` we need to get the average cost and average effect for each strategy. To do this, we use `summary()`, which has a specific version for the `psa` object. To get more information on the `summary.psa()` method, just type `?summary.psa` in the console.

```{r}
avg_cdiff <- summary(cdiff_psa)
head(avg_cdiff)
```

Now, we can calculate the incremental cost-effectiveness ratios on the `avg_cdiff` object.

## Calculate ICERs

```{r}
icer_table <- calculate_icers(cost = avg_cdiff$meanCost,
                              effect = avg_cdiff$meanEffect,
                              strategies = cdiff_psa$strategies)
head(icer_table)
```

The default view is by status (non-dominated, extended dominated, or dominated).

```{r}
library(knitr)
library(kableExtra)
library(dplyr)
icer_table %>%
  kable() %>%
  kable_styling()
```

We can also sort by cost:

```{r message = FALSE}
icer_table %>%
  arrange(Cost) %>%
  kable() %>%
  kable_styling()
```

Finally, we can filter the table to only non-dominated scenarios and the reference scenario:

```{r}
icer_table %>%
  filter(Status %in% c("ND", "ref"))
```

## Plot

We can plot the data in the cost-effectiveness plane using the `plot.icers()` function (which is automatically called when you call `plot()` on the object returned from `calculate_icers()`).

```{r}
plot(icer_table)
```

In the plot, the points on the cost-effectiveness frontier are connected with a blue line.

### Plot options

The `plot.icers()` function has several options - type `?plot.icers` in the console for full deftails. By default, the points on the efficient frontier are labeled with the names of the associated strategy. The names may be too long, in which case they are truncated. These are some options for the plot:

```{r}
plot(icer_table, label = "none") # the default is label = "frontier"
plot(icer_table, label = "all") # can lead to a 'busy' plot
plot(icer_table, currency = "USD", effect_units = "DALYs")
```

Note that the object returned by `plot.icers()` is a normal `ggplot` object, so we can add (`+`) any of the normal ggplot adjustments to the plot. To do this, `ggplot2` needs to be separately installed and loaded with `library()`. A introduction to ggplot2 is hosted at https://ggplot2.tidyverse.org/

Load ggplot2:
```{r}
library(ggplot2)
```

Plot with a different theme:

```{r}
plot(icer_table) +
  theme_classic() +
  ggtitle("Cost-effectiveness of C diff treatments")
```

Finally, we can save this plot to a publication-ready image using `ggsave()`, which saves the most recent ggplot object. 

```
ggsave("icer_table.png", width = 7, height = 5, dpi = 300)
```

The table can also be written to a tabular or comma-separated file like a normal R data table:

```
write.table(icer_table, file = "cdiff_icers.tab",
            quote = FALSE, row.names = FALSE, sep = "\t")
```


# Example 2: HIV Screening

Taken from:

Paltiel, A. David, Rochelle P. Walensky, Bruce R. Schackman, George R. Seage, Lauren M. Mercincavage, Milton C. Weinstein, and Kenneth A. Freedberg. “Expanded HIV Screening in the United States: Effect on Clinical Outcomes, HIV Transmission, and Costs.” Annals of Internal Medicine 145, no. 11 (December 5, 2006): 797. https://doi.org/10.7326/0003-4819-145-11-200612050-00004.

**add details**

```{r}
hiv_strat <- c("ref", "one time", "5yr", "3yr", "1yr")
hiv_cost <- c(26000, 27000, 28020, 28440, 29440)
hiv_qalys <- c(277.25, 277.57, 277.78, 277.83, 277.76) / 12
hiv_cea <- calculate_icers(hiv_cost, hiv_qalys, hiv_strat)
hiv_cea
library(ggplot2)
plot(hiv_cea)
```


```
