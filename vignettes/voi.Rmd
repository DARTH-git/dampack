---
title: "Value of Information Analysis"
author: "Fernando Alarid-Escudero, Greg Knowlton, Eva Enns, and the DARTH Team"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Value of Information Analysis}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 7,
  fig.height = 5,
  fig.align = "center"
)
```

Value of information analysis (VoI) is a method for estimating the expected monetary or health gains from reducing uncertainty in the input parameters of a decision analytic model. Although a particular strategy is optimal because it maximizes expected net benefit given current information, this strategy could be suboptimal for certain plausible combinations of parameter values.  Therefore, the greater the uncertainty in the model input parameters, the greater the risk that the decision that is optimal in expectation is actually suboptimal in reality.  Parameter uncertainty can be reduced through new clinical trials and/or observational studies, and therefore VoI analysis is a useful tool for guiding the optimal allocation of research funds. The decision to fund a future research effort is only advisable if the expected benefit of the resulting reduction in parameter uncertainty outweighs the cost of executing the research effort. 

The expected value of perfect information (EVPI) is the expected benefit per patient of performing a future study with an infinite sample size that would eliminate all parameter uncertainty. EVPI is calculated as the average opportunity loss across all samples in the probabilistic sensitivity analysis. The opportunity loss per sample is defined as the difference between the maximum expected benefit in that sample (had we known the parameters perfectly and made the optimal choice) and the sample's expected benefit given the strategy chosen (the choice being made based on the average expected benefit).

EVPI is frequently reported in terms of the net benefit of perfect information per patient, but \code{calc_evpi} also provides an option to specify the population size to calculate the EVPI for the total population.

The expected value of partial pefect information (EVPPI) is the expected value of perfect information from a subset of parameters of interest, θ_I, of a cost-effectiveness analysis (CEA) of D different strategies with parameters θ = \{ θ_I, θ_C\}, where θ_C is the set of complementary parameters of the CEA. The function calc_evppi computes the EVPPI of θ_I from a matrix of net monetary benefits B of the CEA. Each column of B corresponds to the net benefit B_d of strategy d. The function calc_evppi computes the EVPPI using a linear regression metamodel approach following these steps:

1. Determine the optimal strategy d^* from the expected net benefits \bar{B}

d^* = argmax_{d} \{\bar{B}\}

2. Compute the opportunity loss for each d strategy, L_d

L_d = B_d - B_{d^*}

3. Estimate a linear metamodel for the opportunity loss of each d strategy, L_d, by regressing them on the spline basis functions of θ_I, f(θ_I)

L_d = β_0 + f(θ_I) + ε,

where ε is the residual term that captures the complementary parameters θ_C and the difference between the original simulation model and the metamodel.

4. Compute the EVPPI of θ_I using the estimated losses for each d strategy, \hat{L}_d from the linear regression metamodel and applying the following equation:

EVPPI_{θ_I} = \frac{1}{K}∑_{i=1}^{K}\max_d(\hat{L}_d)

The spline model in step 3 is fitted using the 'mgcv' package.

Whereas EVPI and EVPPI calculate the expected benefit of removing all uncertainty from the parameters, obtaining such perfect information is in practice impossible. We can only hope to reduce uncertainty. This is because of the finite sample size of every study, and limits to the generalizability of the study population to the general population. If we want a precise estimate, we need to calculate the expected value of sample information that will actually be obtained from a new study with finite sample size n. The EVSI is best presented in a graph as a function of sample size, and this graph will asymptotically reach EVPPI/EVPI.
Put in more about the EVSI implementation in the package.

```{r}
library(dampack)
```

```{r}
data("example_psa")
psa_big <- make_psa_obj(example_psa$cost, example_psa$effectiveness,
                        example_psa$parameters, example_psa$strategies)
```

```{r}
mm <- metamodel(analysis = "twoway", psa = psa_big, params = c("pFailChemo", "cChemo"), 
                strategies = "Chemo", outcome = "eff", type = "gam")
```

```{r}
print(mm)
```

```{r}
summary(mm)
```

```{r}
pred_mm <- predict(mm,
                   ranges = list("pFailChemo" = c(0.3, 0.6),
                                  "cChemo" = NULL),
                   nsamp = 10)
head(pred_mm)
```

The expected value of perfect information (EVPI) is the difference between the expected value of the decision made with perfect information about the uncertain parameters, and the decision made on the basis of existing evidence (Drummond). EVPI represents the maximum price that one would be willing to pay in order to gain access to perfect information.

```{r}
evpi_obj <- calc_evpi(psa = psa_big,
                      wtp = example_psa$wtp,
                      pop = 1)
evpi_obj
```

```{r}
p <- plot(evpi_obj,
          txtsize = 16, effect_units = "QALY", currency = "Dollars ($)",
          xbreaks = seq(0, 200, by = 10), ylim = c(0, 100000))
p
```

```{r}
evppi <- calc_evppi(psa = psa_big,
                    wtp = c(1e5, 2e5, 5e5, 1e6),
                    params = c("pFailSurg", "pFailChemo"),
                    outcome = "nmb",
                    type = "gam",
                    k = -1,
                    pop = 1)
evppi
```


```{r}
evsi <- calc_evsi(psa = psa_big,
                    wtp = c(1e5, 2e5, 5e5, 1e6),
                    params = c("pFailSurg", "pFailChemo"),
                    outcome = "nmb",
                    type = "gam",
                    k = -1,
                    n = 100,
                    n0 = 10,
                    pop = 1)
evsi
```
